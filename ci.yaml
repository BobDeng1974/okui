{% set needy_targets = {'iphoneos': 'ios', 'appletvos': 'tvos', 'android': 'android'} %}
{% if target in needy_targets %}
    {% set needy_target_args = '--needy-target-args="-t ' ~ needy_targets[target] ~ '"' %}
{% endif %}
{% if target == 'android' %}
    {% set needy_satisfy_args = '--needy-satisfy-args="--android-toolchain=$ANDROID_TOOLCHAIN"' %}
    {% set b2_config_args = '--android-toolchain=$ANDROID_TOOLCHAIN' %}
{% endif %}
{% set b2_args = '-j' ~ cpu_count ~ ' -d+2' %}
script:
    {% if target == 'linux' %}
    - export CXXFLAGS=-stdlib=libc++; export LDFLAGS=-stdlib=libc++;
    {% endif %}
    - ./build-deps --bootstrap-b2 --configure --variant=release {{ needy_target_args }} {{ needy_satisfy_args }}
    - export PATH=`pwd`/bootstrap:$PATH
    - live b2-config --target={{ target }} {{ b2_config_args }} > project-config.jam
    - b2 {{ b2_args }} variant=release
    {% if target in ['macosx', 'linux'] %}
    - b2 {{ b2_args }} variant=release tests//run
    {% endif %}
    - live c++-analysis b2 {{ b2_args }} --build-dir=./bin/analysis
