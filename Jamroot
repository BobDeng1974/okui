project okui ;

path-constant NEEDS_PATH : needs ;

lib libiconv : : <name>iconv ;

rule okui-frameworks ( properties * ) {
    if <target-os>iphone in $(properties) || <target-os>appletv in $(properties) || <target-os>darwin in $(properties) {
        local result ;
        result += <framework>CoreFoundation ;
        result += <framework>Foundation ;

        if <target-os>darwin in $(properties) {
            result += <framework>OpenGL ;
        }

        return $(result) ;
    }
}

lib GL     : : <link>shared ;
lib m      : : <link>shared ;
lib GLESv2 : : <link>shared ;

alias objc : : : :
    <target-os>darwin:<cxxflags>"-x objective-c++"
    <target-os>iphone:<cxxflags>"-x objective-c++"
    <target-os>appletv:<cxxflags>"-x objective-c++"
    <target-os>darwin:<cflags>-fobjc-arc
    <target-os>iphone:<cflags>-fobjc-arc
    <target-os>appletv:<cflags>-fobjc-arc
;

local PKG_CONFIG_PATH = [ modules.peek project-config : PKG_CONFIG_PATH ] ;
local PKG_CONFIG_DEPENDENCIES = [ modules.peek project-config : PKG_CONFIG_DEPENDENCIES ] ;
local OWNED_DEPENDENCIES = [ modules.peek project-config : OWNED_DEPENDENCIES ] ;

rule dep ( name : packages * ) {
    if ! $(packages) {
        packages = $(name) ;
    }
    if $(packages) in $(PKG_CONFIG_DEPENDENCIES) {
        local cflags = [ SHELL "PKG_CONFIG_PATH=$(PKG_CONFIG_PATH) pkg-config $(packages:J= ) --cflags | tr -d '\n'" ] ;
        local ldflags = [ SHELL "PKG_CONFIG_PATH=$(PKG_CONFIG_PATH) pkg-config $(packages:J= ) --libs --static | tr -d '\n'" ] ;
        alias $(name) : : : : <cflags>$(cflags) <linkflags>$(ldflags) ;
    }
    if $(packages) in $(OWNED_DEPENDENCIES) {
        alias install-$(name)-if-owned : $(NEEDS_PATH)//install-$(name) ;
    } else {
        alias install-$(name)-if-owned ;
    }
    explicit install-$(name)-if-owned ;
}

dep scraps ;
dep jshackle ;
dep sdl2 ;
dep utf8 ;
dep libjpeg-turbo : libturbojpeg ;
dep libpng ;

lib okui :
    [ glob-tree-ex src : *.cpp ]
    scraps
    libpng
    libjpeg-turbo
    sdl2
    objc
    utf8
:
    <include>include
    <cxxflags>"-std=c++1y"
    <link>static
    [ conditional <target-os>linux :
        <source>GL
        <source>m
    ]
    <target-os>android:<source>jshackle
: :
    <include>include
    <cxxflags>"-std=c++1y"
    <conditional>@okui-frameworks
    <target-os>android:<source>GLESv2
;

import package ;

package.install install-lib : <install-source-root>include : : okui : [ glob-tree-ex include : *.h ] ;

path-constant PREFIX : [ option.get prefix : "/usr/local" ] ;
path-constant LIB : [ option.get libdir : $(PREFIX)/lib ] ;
path-constant PKG_CONFIG : $(LIB)/pkgconfig ;

make okui.pc : Jamroot : @pkgconfig ;
rule pkgconfig ( targets * : sources * : properties * ) {
    if <target-os>darwin in $(properties) {
        PRIVATE_LIBS on $(targets) = -framework Foundation -framework OpenGL ;
    } else if <toolset>darwin in $(properties) {
        PRIVATE_LIBS on $(targets) = -framework Foundation ;
    } else if <target-os>linux in $(properties) {
        PRIVATE_LIBS on $(targets) = -lGL ;
    }
}
actions pkgconfig {
cat > $(<) <<- EOM
prefix=\${pcfiledir}/../..
exec_prefix=\${prefix}
libdir=\${exec_prefix}/lib
includedir=\${exec_prefix}/include

Name: okui
Version: 0
Description: Okay UI library
Requires: scraps libpng libturbojpeg sdl2 utf8
Libs: -L\${libdir} -lokui
Libs.private: $(PRIVATE_LIBS)
Cflags: -I\${includedir}
EOM
}

install install-pkgconfig : okui.pc : <location>$(PKG_CONFIG) ;

install install-android : [ glob-tree-ex android : *.java *.gradle ] : <location>$(PREFIX)/share/okui <install-source-root>android ;

alias install :
    install-lib
    install-pkgconfig
    install-scraps-if-owned
    install-jshackle-if-owned
    install-libpng-if-owned
    install-libjpeg-turbo-if-owned
    install-sdl2-if-owned
    install-utf8-if-owned
:
    <target-os>android:<source>install-android
;

explicit install install-lib install-pkgconfig install-android ;
